name: Android AAB Prerelease (Manual)

on:
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: aab-prerelease-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-aab-prerelease:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Generate Android platform scaffolding
        run: flutter create --platforms=android --project-name book_app_themed --org com.blackpiratex .

      - name: Install Firebase Android config
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f google-services.json ]; then
            echo "::error::Missing google-services.json in repository root"
            exit 1
          fi
          cp google-services.json android/app/google-services.json
          ls -lh android/app/google-services.json

      - name: Validate Android signing secrets
        shell: bash
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          set -euo pipefail
          missing=0
          for name in ANDROID_KEYSTORE_BASE64 ANDROID_KEYSTORE_PASSWORD ANDROID_KEY_ALIAS ANDROID_KEY_PASSWORD; do
            if [ -z "${!name:-}" ]; then
              echo "::error::Missing required GitHub secret mapped to $name"
              missing=1
            fi
          done
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: Decode Android release keystore
        shell: bash
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          set -euo pipefail
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > android/app/ci-release.jks
          ls -lh android/app/ci-release.jks

      - name: Install SVG renderer
        run: |
          sudo apt-get update
          sudo apt-get install -y librsvg2-bin

      - name: Configure Android package, label, permission, and launcher icon
        run: |
          python3 scripts/configure_generated_android.py
          ICON_SVG="assets/icons/blackpiratex_book_tracker_icon.svg"
          find android/app/src/main/res -type f -name 'ic_launcher*.png' | sort | while read -r file; do
            dir_name="$(basename "$(dirname "$file")")"
            base_name="$(basename "$file")"
            case "$dir_name" in
              mipmap-mdpi) launcher_size=48; foreground_size=108 ;;
              mipmap-hdpi) launcher_size=72; foreground_size=162 ;;
              mipmap-xhdpi) launcher_size=96; foreground_size=216 ;;
              mipmap-xxhdpi) launcher_size=144; foreground_size=324 ;;
              mipmap-xxxhdpi) launcher_size=192; foreground_size=432 ;;
              *) continue ;;
            esac
            size="$launcher_size"
            case "$base_name" in
              *foreground*|*monochrome*)
                size="$foreground_size"
                ;;
            esac
            rsvg-convert -w "$size" -h "$size" "$ICON_SVG" -o "$file"
          done

      - name: Install dependencies
        run: flutter pub get

      - name: Analyze
        run: flutter analyze

      - name: Build release AAB
        run: flutter build appbundle --release
        env:
          ANDROID_KEYSTORE_PATH: ${{ github.workspace }}/android/app/ci-release.jks
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-aab
          path: build/app/outputs/bundle/release/app-release.aab

      - name: Prepare release metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          short_sha="$(printf '%s' "${GITHUB_SHA}" | cut -c1-7)"
          tag="pre-aab-${GITHUB_RUN_NUMBER}-${short_sha}"
          title="AAB Prerelease #${GITHUB_RUN_NUMBER} (${short_sha})"
          {
            echo "tag=$tag"
            echo "title=$title"
          } >> "$GITHUB_OUTPUT"

      - name: Create prerelease
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: ${{ steps.meta.outputs.title }}
          prerelease: true
          target_commitish: ${{ github.sha }}
          generate_release_notes: true
          body: |
            Auto-generated manual AAB prerelease.

            Source workflow: `${{ github.workflow }}`
            Run number: `${{ github.run_number }}`
            Commit: `${{ github.sha }}`
          files: |
            build/app/outputs/bundle/release/app-release.aab
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
